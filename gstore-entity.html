<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>知识元详情 - 知识图谱管理系统 Powered by gStore</title>
    <!-- Bootstrap Styles-->
    <link href="assets/css/bootstrap.css" rel="stylesheet" />
    <!-- FontAwesome Styles-->
    <link href="assets/css/font-awesome.css" rel="stylesheet" />
    <!-- Morris Chart Styles-->

    <!-- Custom Styles-->
    <link href="assets/css/custom-styles.css" rel="stylesheet" />
    <!-- Google Fonts-->
    <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css' />
    <!-- TABLE STYLES-->
    <link href="assets/js/dataTables/dataTables.bootstrap.css" rel="stylesheet" />
    <!-- DECEMBERCAFE STYLES-->
    <!--<link href="assets/decembercafe/relationship.css" rel="stylesheet" />-->
</head>

<body>
    <div id="wrapper">

        <nav class="navbar navbar-default top-navbar" role="navigation">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".sidebar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="index.html">gStore</a>
            </div>

        </nav>
        <!--/. NAV TOP  -->

        <nav class="navbar-default navbar-side" role="navigation">
            <div class="sidebar-collapse">
                <ul class="nav" id="main-menu">
                    <li>
                        <a id="a-dash" href="gstore-dashboard.html"><i class="fa fa-fw fa-file"></i> 控制面板 </a>
                    </li>
                    <li>
                        <a id="a-tb" href="gstore-table.html"><i class="fa fa-fw fa-file"></i> 列表视图 </a>
                    </li>
                    <li>
                        <a id="a-gr" href="gstore-graph.html"><i class="fa fa-fw fa-file"></i> 图谱视图 </a>
                    </li>
                    <li>
                        <a id="a-dt" href="gstore-entity.html" class="active-menu"><i class="fa fa-fw fa-file"></i> 知识元详情 </a>
                    </li>
                    <li>
                        <a id="a-sp" href="gstore-sparql.html"><i class="fa fa-fw fa-file"></i> SPARQL查询 </a>
                    </li>
                    <li>
                        <a id="a-hp" href="gstore-help.html"><i class="fa fa-fw fa-file"></i> 帮助 </a>
                    </li>
                </ul>
            </div>
        </nav>
        <!-- /. NAV SIDE  -->

        <div id="page-wrapper">
            <div id="page-inner">
                <div class="row">
                    <div class="col-md-10">
                        <h1 class="page-header">
                            <span id="entity-name"></span> <small>知识元详情</small>
                        </h1>
                    </div>
                    <div class="col-md-2">
                        <div class="pull-right">
                            <button class="btn btn-info btn-sm" id="btn-hide-edge-label"><span class="glyphicon glyphicon-hand-up"></span> <span>不显示边标签</span> </button>
                        </div>
                    </div>

                </div>

                <div class="row">
                    <div class="col-md-12">
                        <div class="showcase">
                            <canvas id="entity-canvas" height="800" width="1300" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></canvas>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-xs-12">
                        <div id="alert-add-success" class="alert alert-success" style="display:none;">
                            <strong>三元组添加成功</strong>
                        </div>
                        <div id="alert-add-fail" class="alert alert-danger" style="display:none;">
                            <strong>三元组添加失败</strong>
                        </div>
                        <div id="alert-del-success" class="alert alert-success" style="display:none;">
                            <strong>三元组删除成功</strong>
                        </div>
                        <div id="alert-del-fail" class="alert alert-danger" style="display:none;">
                            <strong>三元组删除失败</strong>
                        </div>
                        <div id="alert-upd-success" class="alert alert-success" style="display:none;">
                            <strong>三元组更新成功</strong>
                        </div>
                        <div id="alert-upd-fail" class="alert alert-danger" style="display:none;">
                            <strong>三元组更新失败</strong>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-xs-12">
                        <div class="panel panel-default panel-table">
                            <div class="panel-heading">
                                <div class="row">
                                    <div class="col col-sm-6">
                                        <label>三元组：</label>
                                    </div>
                                    <div class="col col-sm-6 text-right">
                                        <button class="btn btn-info btn-sm btn-create" data-title="Delete" data-toggle="modal" data-target="#insert"><span class="glyphicon glyphicon-plus-sign"></span> <span>新建</span> </button>
                                    </div>
                                </div>
                            </div>
                            <div class="panel-body">
                                <div id="query-ans"></div>
                            </div>

                            <div class="modal fade" id="insert" tabindex="-1" role="dialog" aria-labelledby="insert" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">

                                        <div class="modal-header">
                                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><span class="glyphicon glyphicon-insert" aria-hidden="true"></span></button>
                                            <h4 class="modal-title custom_align" id="Heading">新建知识元</h4>
                                        </div>

                                        <div class="modal-body">
                                            <div class="form-group">
                                                <label class="control-label" for="insert-title">名称</label>
                                                <input id="insert-title" class="form-control " type="text" placeholder="名称不能为空">
                                                <!-- disabled -->
                                            </div>

                                            <div class="form-group">
                                                <label class="control-label" for="insert-description">简介</label>
                                                <textarea id="insert-description" rows="3" class="form-control" placeholder="在这里填写知识元简介"></textarea>
                                            </div>
                                        </div>

                                        <div class="modal-footer ">
                                            <button type="button" class="btn btn-warning btn-lg" id="confirm-insert" data-dismiss="modal" style="width: 100%;"><span class="glyphicon glyphicon-ok-sign"></span> 新建</button>
                                        </div>
                                    </div>
                                    <!-- /.modal-content -->
                                </div>
                                <!-- /.modal-dialog -->
                            </div>



                            <div class="modal fade" id="edit" tabindex="-1" role="dialog" aria-labelledby="edit" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">

                                        <div class="modal-header">
                                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></button>
                                            <h4 class="modal-title custom_align" id="Heading">编辑知识元</h4>
                                        </div>

                                        <div class="modal-body">
                                            <div class="form-group">
                                                <label class="control-label" for="edit-title">名称</label>
                                                <input id="edit-title" class="form-control " type="text" placeholder="Title">
                                                <!-- disabled -->
                                            </div>

                                            <div class="form-group">
                                                <label class="control-label" for="edit-description">简介</label>
                                                <textarea id="edit-description" rows="3" class="form-control" placeholder="Descrition"></textarea>
                                            </div>
                                        </div>

                                        <div class="modal-footer ">
                                            <button type="button" class="btn btn-warning btn-lg" id="confirm-update" data-dismiss="modal" style="width: 100%;"><span class="glyphicon glyphicon-ok-sign"></span> 更新</button>
                                        </div>
                                    </div>
                                    <!-- /.modal-content -->
                                </div>
                                <!-- /.modal-dialog -->
                            </div>


                            <div class="modal fade" id="delete" tabindex="-1" role="dialog" aria-labelledby="edit" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">

                                        <div class="modal-header">
                                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></button>
                                            <h4 class="modal-title custom_align" id="Heading">删除知识元</h4>
                                        </div>

                                        <div class="modal-body">

                                            <div class="alert alert-danger"><span class="glyphicon glyphicon-warning-sign"></span> 即将删除这条知识元，以及相关的知识元关系链接，确定吗？</div>
                                            <div>
                                                <p id="dp-title">null</p>
                                            </div>
                                        </div>

                                        <div class="modal-footer ">
                                            <button type="button" class="btn btn-success" id="confirm-delete" data-dismiss="modal"><span class="glyphicon glyphicon-ok-sign"></span> 是</button>
                                            <button type="button" class="btn btn-default" data-dismiss="modal"><span class="glyphicon glyphicon-remove"></span> 否</button>
                                        </div>
                                    </div>
                                    <!-- /.modal-content -->
                                </div>
                                <!-- /.modal-dialog -->
                            </div>

                        </div>
                    </div>
                </div>

                <footer>
                    <p>All right reserved. Template by: <a href="http://webthemez.com ">WebThemez</a></p>
                </footer>
            </div>
            <!-- /. PAGE INNER  -->
        </div>
        <!-- /. PAGE WRAPPER  -->
        <!-- /. WRAPPER  -->
        <!-- JS Scripts-->
        <!-- jQuery Js -->
        <script src="assets/js/jquery-1.10.2.js "></script>
        <!-- Bootstrap Js -->
        <script src="assets/js/bootstrap.min.js "></script>
        <!-- Metis Menu Js -->
        <script src="assets/js/jquery.metisMenu.js "></script>
        <!-- DATA TABLE SCRIPTS -->
        <script src="assets/js/dataTables/jquery.dataTables.js "></script>
        <script src="assets/js/dataTables/dataTables.bootstrap.js "></script>
        <!-- Custom Js -->
        <script src="assets/js/gstore-util.js"></script>
        <script src="assets/js/gstore-gstore.js"></script>
        <script src="assets/decembercafe/d3.min.js"></script>
        <script src="assets/decembercafe/relation.js"></script>

        <script>
            $(document).ready(function () {

                function setURL() {
                    $("#a-dash")[0].href = getURL($("#a-dash")[0].href, { "ip": global_ip, "port": global_port, "db": global_dbname });
                    $("#a-tb")[0].href = getURL($("#a-tb")[0].href, { "ip": global_ip, "port": global_port, "db": global_dbname });
                    $("#a-gr")[0].href = getURL($("#a-gr")[0].href, { "ip": global_ip, "port": global_port, "db": global_dbname });
                    $("#a-dt")[0].href = getURL($("#a-dt")[0].href, { "ip": global_ip, "port": global_port, "db": global_dbname });
                    $("#a-sp")[0].href = getURL($("#a-sp")[0].href, { "ip": global_ip, "port": global_port, "db": global_dbname });
                    $("#a-hp")[0].href = getURL($("#a-hp")[0].href, { "ip": global_ip, "port": global_port, "db": global_dbname });
                }

                var params = parseURL(document.URL);
                if (Object.keys(params).length > 0) {
                    global_ip = params["ip"];
                    global_port = params["port"];
                    global_dbname = params["db"];
                    document.showEdgeLabel = params["el"];

                    setURL();
                }

                function getEntityShortName(eid) {
                    return eid.substring(eid.lastIndexOf('/') + 1);
                }

                var entity_id = "http://www.summba.com/ontologies/music/周杰伦"
                if (document.location.hash.length > 0) {
                    entity_id = document.location.hash.substring(1);
                }
                $("#entity-name").text(getEntityShortName(entity_id));

                if (document.showEdgeLabel == "true") {
                    $('#btn-hide-edge-label span:last-child').text("不显示边标签");
                } else {
                    $('#btn-hide-edge-label span:last-child').text("显示边标签");
                }

                $('#btn-hide-edge-label').click(function () {
                    if (document.showEdgeLabel == "true") {
                        location.href = `gstore-entity.html?ip=${global_ip}&port=${global_port}&db=${global_dbname}${location.hash}`;
                    } else {
                        location.href = `gstore-entity.html?ip=${global_ip}&port=${global_port}&db=${global_dbname}&el=true${location.hash}`;
                    }
                });

                // =========================
                // init entity graph
                // =========================

                function initColor(r) {
                    r[0].color = "#007FFF",
                        r[1].color = "#A142FF",
                        r[2].color = "#FF85C2",
                        r[3].color = "#FFA142",
                        r[4].color = "#FF4242";

                    for (var o = 5; o < r.length; o++) {
                        var t = d3.color(r[o % 4 + 1].color);
                        r[o].color = t.brighter(1.5).toString()
                    }
                }

                function initRadius(r) {
                    r[0].radius = 18;
                    // r[1].radius = 14,
                    // r[2].radius = 14,
                    // r[3].radius = 14,
                    // r[4].radius = 14;
                    for (var o = 1; o < r.length; o++)
                        r[o].radius = 10
                }

                var canvas = document.querySelector("canvas"),
                    width = 1300,
                    height = 800;

                // mycsv = "id,name\n0,Geoff\n1,School\n2,Company\n3,Family\n4,Network\n5,Aaron\n6,Abbott\n7,Jacob\n8,James\n9,Kelvin\n10,Kendall\n11,Kendrick\n12,Leroy\n13,Leslie\n14,Lester\n15,Magnus\n16,Malcolm\n17,Melvin\n18,Perry\n19,Peter\n20,Peyton\n21,Royce\n22,Rufus\n23,Rupert\n24,Hadden\n25,Hadley\n26,Hadwin\n27,Hal\n28,Halbert\n29,Halden\n30,Hale\n31,Gilroy\n32,Glenn\n33,Goddard\n34,Godfrey\n35,Godwin\n36,Graham\n37,Grant\n38,Tobias\n39,Toby\n40,Todd\n41,Tony\n42,Travis\n43,Trent\n44,Trevor\n45,Tristan\n46,Troy\n47,Truman\n48,Tyler";

                function initGraph(nodes, edges) {
                    var o = nodes.map(x => ({ id: x[0], name: x[1] }));

                    var i = edges.map(x => ({ source: x[0], target: x[1], label: x[2], isuri: x[3] }));

                    // for (var t = (o.length, 4), i = [], e = 1; e <= t; e++)
                    //     i.push({ source: 0, target: e });

                    // for (var e = t + 1; e < o.length; e++)
                    //     i.push({ source: e % t + 1, target: e });

                    console.log(edges);

                    initColor(o),
                        initRadius(o);

                    var s = new relation;
                    s.setNodes(o),
                        s.setLinks(i),
                        s.setCanvas(canvas),
                        s.setSize(width, height),
                        s.setRadius(12),
                        s.setLinkLength(90),
                        s.setCharge(-60),
                        s.setShowEdgeLabel(document.showEdgeLabel == "true"),
                        s.init(),
                        s.run()
                }

                gstore.getEntityGraphData(
                    entity_id,
                    initGraph,
                    function () { }
                )

                // init(d3.csvParse(mycsv))

                // =========================
                // entity table
                // =========================

                $("#query-ans").hide();

                var sparql = `select ?subject ?predicate ?object where {{<${entity_id}> ?predicate ?object.} UNION {?subject ?predicate <${entity_id}>.}}`;

                gstore.query(
                    sparql,
                    function (data, status) {

                        var table = $('#rs-table');
                        if (table.length > 0) {
                            try {
                                table.DataTable().clear().draw();
                            } catch (error) {
                                console.log("no datatable exists yet");
                            }
                        }

                        $("#query-ans").empty();

                        var obj = JSON.parse(data.replace(/"value": "\s+/g, '"value": "').replace(/\s+" }/g, '" }'));
                        var thead = obj["head"]["vars"];
                        var resultset = obj["results"]["bindings"].map(function (r) {
                            return thead.map(function (x) {
                                if (r[x] == undefined) {
                                    return entity_id;
                                } else {
                                    return r[x]["value"];
                                }
                            })
                        });

                        rs = [thead, resultset];

                        var new_thead = "<thead><tr id=\"tr-input\">" + rs[0].map((x) => ("<th>" + x + "</th>")).join("") + "</tr></thead>";
                        var new_tbody = "<tbody>" + rs[1].map(
                            (r) => ("<tr>" + r.map((c) => ("<td>" + c + "</td>")).join("") + "</tr>")
                        ).join("") + "</tbody>";
                        var new_table = "<table id=\"rs-table\" class=\"table table-bordered table-striped table-hover\">\n" + new_thead + "\n" + new_tbody + "\n</table>"

                        var table = $(new_table);
                        $("#query-ans").append(table);

                        try {
                            $("#rs-table").dataTable();
                        } catch (error) {

                        }
                        $("#query-ans").show();
                    },
                    function () { }
                );

            });
        </script>

</body>

</html>